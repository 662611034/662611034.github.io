<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="UTF-8"><meta http-equiv="Content-Security-Policy"
content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://662611034.github.io">

    
    <title>
愛されたいねん • Px Downloaderの代用品改</title>

    
    
    

    
    
        
            
            
                
                    <link rel="alternate" type="application/atom+xml" title="愛されたいねん - Atom Feed" href="https://662611034.github.io/atom.xml">
                
            
        
    

    
    
    
        
            <link rel="stylesheet" href="https://662611034.github.io/custom_subset.css?h=0b9535a28bc3d5bf2321">
        
    

    
        <link rel="stylesheet" href="https://662611034.github.io/main.css?h=045c365e19a4d50a64bb" />

    <meta name="color-scheme" content="light dark" />
        <meta name="description" content="個人ブログ" />
        <meta property="og:description" content="個人ブログ" />

    

    <meta property="og:title" content="Px Downloaderの代用品改" />
    <meta property="og:type" content="article" />

    
<meta property="og:locale" content="en_GB" />

    <meta property="og:url" content="https:&#x2F;&#x2F;662611034.github.io&#x2F;blog&#x2F;generic-px-downloader-g&#x2F;" /><meta property="og:site_name" content="愛されたいねん">
        <noscript><link rel="stylesheet" href="https://662611034.github.io/no_js.css"/></noscript>
        <script type="text/javascript" src="https://662611034.github.io/js/initializeTheme.min.js"></script>
        <script defer src="https://662611034.github.io/js/themeSwitcher.min.js"></script><script defer src="https://662611034.github.io/search_index.en.js?h=98ecb4d2b5718ee95e83"></script>
        <script defer src="https://662611034.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script>

        
    
</head>


<body>
    <a href="#main-content" id="skip-link">Skip to content</a>
    <header>
    <nav class="navbar">
        <div class="nav-title">
            <a class="home-title" href="https://662611034.github.io/">愛されたいねん</a>
        </div>
            <div class="nav-navs">
                <ul>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://662611034.github.io/blog/">blog
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://662611034.github.io/archive/">archive
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://662611034.github.io/tags/">tags
                                </a>
                            </li>
                        
                            <li>
                                <a class="nav-links no-hover-padding" href="https://662611034.github.io/projects/">projects
                                </a>
                            </li>
                        <li class="menu-icons-container">
                        <ul class="menu-icons-group">
                            <li class="js menu-icon">
                                <div role="button" tabindex="0" id="search-button" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" aria-label="Click or press $SHORTCUT to open search">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                        <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                                    </svg>
                                </div>
                            </li>

                            
                            

                            <li class="theme-switcher-wrapper js"><div
        title="Toggle dark&#x2F;light mode"
        class="theme-switcher"
        tabindex="0"
        role="button"
        aria-label="Toggle dark mode"
        aria-pressed="false">
    </div><div
        title="Reset mode to default"
        class="theme-resetter arrow"
        tabindex="0"
        role="button"
        aria-hidden="true"
        aria-label="Reset mode to default">
    </div>

</li>
</ul>
                    </li>
                </ul>
            </div>
        
    </nav>
</header>

    <div class="content" id="main-content">

        
        





<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            Px Downloaderの代用品改
        </h1>
        <a class="u-url u-uid" href="https://662611034.github.io/blog/generic-px-downloader-g/"></a>

        <ul class="meta"><span class="hidden p-author h-card">
<a rel="author" href="https:&#x2F;&#x2F;662611034.github.io" class="u-url " title=""></a>
</span>
<li><time class="dt-published" datetime="2025-08-09">9th Aug 2025</time></li><li title="406 words"><span class='separator' aria-hidden='true'>•</span>3 min read</li><li class="tag"><span class='separator' aria-hidden='true'>•</span>Tags:&nbsp;</li><li class="tag"><a class="p-category" href="https://662611034.github.io/tags/python/">python</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://662611034.github.io/tags/pixiv/">pixiv</a>,&nbsp;</li><li class="tag"><a class="p-category" href="https://662611034.github.io/tags/puroguramingu/">プログラミング</a></li>
        </ul><section class="e-content body"><h1 id="za-shuo-w">雑説w</h1>
<p>以前Firefoxアドオンの「<a rel="external" href="https://addons.mozilla.org/ja/firefox/addon/px-downloader/">Px Downloader</a>」の代わりになるようなコードを[Pythonで作った]({% post_url 2025-06-24-generic-px-downloader %})Pythonで作ったのだが、</p>
<ul>
<li>画像のオリジナルurl</li>
<li>枚数</li>
</ul>
<p>をいちいち手動で調べて手動でコピペするのがどうもめんどくさい。</p>
<p>前回は画像の枚数の調べ方を聞いてもいい感じのコードを書いてくれなかったが、ちょうど数日前にChatGPTの有料プランも契約したし(別件)、GPT5もリリースされたしでもう一度試してみたら、本家のデフォルト設定には大体近づいたできになったので公開する。</p>
<p>「/ajax API」という、外部に公開していないAPIを使って取得するらしい。非公開だけどブラウザの開発者ツールで確認できちゃうらしい。</p>
<h1 id="ben-ti">本体</h1>
<p><strong>pxdl.py</strong></p>
<pre class="giallo z-code"><code data-lang="python"><span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># -*- coding: utf-8 -*-</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">&quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">Pixiv 静止画一括ダウンロード（/ajax 利用）</span></span>
<span class="giallo-l"><span class="z-string">要：自分の PHPSESSID（ログイン済み）</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">&quot;&quot;&quot;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> os</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> re</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> time</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> pathlib</span></span>
<span class="giallo-l"><span class="z-keyword">from</span><span class="z-source"> typing</span><span class="z-keyword"> import</span><span class="z-source"> Dict</span><span class="z-punctuation">,</span><span class="z-source"> List</span><span class="z-punctuation">,</span><span class="z-source"> Tuple</span><span class="z-punctuation">,</span><span class="z-source"> Optional</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> requests</span></span>
<span class="giallo-l"><span class="z-keyword">from</span><span class="z-source"> urllib</span><span class="z-punctuation">.</span><span class="z-source">parse</span><span class="z-keyword"> import</span><span class="z-source"> urlsplit</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-source"> sys</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">UA</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> (</span><span class="z-punctuation z-definition z-string z-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) &quot;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">      &quot;AppleWebKit/537.36 (KHTML, like Gecko) &quot;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">      &quot;Chrome/123.0.0.0 Safari/537.36&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># ---------- 1) 情報取得関数 ----------</span></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> get_post_info</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">artwork_url</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> phpsessid</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">) -&gt;</span><span class="z-source"> Dict</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    入力: 作品URL（例: https://www.pixiv.net/artworks/133650546）, PHPSESSID</span></span>
<span class="giallo-l"><span class="z-string">    返却: {</span></span>
<span class="giallo-l"><span class="z-string">        &quot;user_name&quot;: str,</span></span>
<span class="giallo-l"><span class="z-string">        &quot;user_id&quot;: str,</span></span>
<span class="giallo-l"><span class="z-string">        &quot;title&quot;: str,</span></span>
<span class="giallo-l"><span class="z-string">        &quot;post_id&quot;: str,</span></span>
<span class="giallo-l"><span class="z-string">        &quot;count&quot;: int,</span></span>
<span class="giallo-l"><span class="z-string">        &quot;image_urls&quot;: List[str],  # original が取れない時は regular で代替</span></span>
<span class="giallo-l"><span class="z-string">    }</span></span>
<span class="giallo-l"><span class="z-string">    ※ うごイラ(illustType==2)は未対応 -&gt; 例外</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    m</span><span class="z-keyword z-operator"> =</span><span class="z-source"> re</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">search</span><span class="z-punctuation">(</span><span class="z-storage z-type z-string z-python">r</span><span class="z-punctuation z-definition z-string z-begin">&quot;</span><span class="z-string">/artworks/</span><span class="z-punctuation">(</span><span class="z-string">\d</span><span class="z-keyword z-operator z-quantifier z-regexp">+</span><span class="z-punctuation">)</span><span class="z-punctuation z-definition z-string z-end">&quot;</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> artwork_url</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">    if not</span><span class="z-source"> m</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> ValueError</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;artwork URL から投稿IDを抽出できませんでした。&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    post_id</span><span class="z-keyword z-operator"> =</span><span class="z-source"> m</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">group</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    s</span><span class="z-keyword z-operator"> =</span><span class="z-source"> requests</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Session</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    s</span><span class="z-punctuation">.</span><span class="z-source">headers</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">update</span><span class="z-punctuation">({</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;User-Agent&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> UA</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;Referer&quot;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &quot;https://www.pixiv.net/&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;Accept&quot;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &quot;application/json, text/plain, */*&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">    })</span></span>
<span class="giallo-l"><span class="z-source">    s</span><span class="z-punctuation">.</span><span class="z-source">cookies</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">set</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;PHPSESSID&quot;</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> phpsessid</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">strip</span><span class="z-punctuation">().</span><span class="z-meta z-function-call z-python">strip</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&#39;&quot;&#39;</span><span class="z-punctuation">).</span><span class="z-meta z-function-call z-python">strip</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;&#39;&quot;</span><span class="z-punctuation">),</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                  domain</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;.pixiv.net&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> path</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;/&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 基本情報</span></span>
<span class="giallo-l"><span class="z-source">    r</span><span class="z-keyword z-operator"> =</span><span class="z-source"> s</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-string">&quot;https://www.pixiv.net/ajax/illust/</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-meta z-function-call z-arguments z-python">post_id</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> timeout</span><span class="z-keyword z-operator">=</span><span class="z-constant z-numeric">15</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">raise_for_status</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    meta</span><span class="z-keyword z-operator"> =</span><span class="z-source"> r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">json</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> meta</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;error&quot;</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> RuntimeError</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">meta</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;message&quot;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &quot;ajax/illust エラー&quot;</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"><span class="z-source">    body</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-indexed-name z-python"> meta</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">body</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">]</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    illust_type</span><span class="z-keyword z-operator"> =</span><span class="z-support z-type z-python"> int</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">body</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;illustType&quot;</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 0</span><span class="z-punctuation">))</span><span class="z-punctuation z-definition z-comment z-comment">  # 0/1:静止画, 2:ugoira</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> illust_type</span><span class="z-keyword z-operator"> ==</span><span class="z-constant z-numeric"> 2</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> NotImplementedError</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;うごイラは非対応です（静止画のみ）。&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    user_name</span><span class="z-keyword z-operator"> =</span><span class="z-source"> body</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;userName&quot;</span><span class="z-punctuation">)</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-punctuation z-definition z-string"> &quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    user_id</span><span class="z-keyword z-operator"> =</span><span class="z-source"> body</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;userId&quot;</span><span class="z-punctuation">)</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-punctuation z-definition z-string"> &quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    title</span><span class="z-keyword z-operator"> =</span><span class="z-source"> body</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;illustTitle&quot;</span><span class="z-punctuation">)</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-punctuation z-definition z-string"> &quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    count</span><span class="z-keyword z-operator"> =</span><span class="z-support z-type z-python"> int</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">body</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;pageCount&quot;</span><span class="z-punctuation">,</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 各ページのURL</span></span>
<span class="giallo-l"><span class="z-source">    r</span><span class="z-keyword z-operator"> =</span><span class="z-source"> s</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-string">&quot;https://www.pixiv.net/ajax/illust/</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-meta z-function-call z-arguments z-python">post_id</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">/pages&quot;</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> timeout</span><span class="z-keyword z-operator">=</span><span class="z-constant z-numeric">15</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">raise_for_status</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    pj</span><span class="z-keyword z-operator"> =</span><span class="z-source"> r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">json</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> pj</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;error&quot;</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> RuntimeError</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">pj</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;message&quot;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &quot;ajax/illust/pages エラー&quot;</span><span class="z-punctuation">))</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    image_urls</span><span class="z-punctuation">:</span><span class="z-meta z-indexed-name z-python"> List</span><span class="z-punctuation">[</span><span class="z-support z-type z-python">str</span><span class="z-punctuation">]</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> []</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    for</span><span class="z-source"> p</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-meta z-indexed-name z-python"> pj</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">body</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">]:</span></span>
<span class="giallo-l"><span class="z-source">        urls</span><span class="z-keyword z-operator"> =</span><span class="z-source"> p</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;urls&quot;</span><span class="z-punctuation">, {})</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-punctuation"> {}</span></span>
<span class="giallo-l"><span class="z-source">        u</span><span class="z-keyword z-operator"> =</span><span class="z-source"> urls</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;original&quot;</span><span class="z-punctuation">)</span><span class="z-keyword z-operator z-logical z-python"> or</span><span class="z-source"> urls</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;regular&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        if</span><span class="z-source"> u</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">            image_urls</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">append</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 念のため整合</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">    if not</span><span class="z-source"> image_urls</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        raise</span><span class="z-support z-type z-exception z-python"> RuntimeError</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;画像URLを取得できませんでした（ログイン状態や権限を確認してください）。&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-punctuation"> {</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;user_name&quot;</span><span class="z-punctuation">:</span><span class="z-source"> user_name</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;user_id&quot;</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">user_id</span><span class="z-punctuation">),</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;title&quot;</span><span class="z-punctuation">:</span><span class="z-source"> title</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;post_id&quot;</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">post_id</span><span class="z-punctuation">),</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;count&quot;</span><span class="z-punctuation">:</span><span class="z-source"> count</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;image_urls&quot;</span><span class="z-punctuation">:</span><span class="z-source"> image_urls</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">    }</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># ---------- 2) Windows用ディレクトリ名生成 ----------</span></span>
<span class="giallo-l"><span class="z-source">_WIN_FORBIDDEN</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> {</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &#39;&lt;&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;＜&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;&gt;&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;＞&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;:&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;：&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;&quot;&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;”&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;/&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;／&#39;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &#39;</span><span class="z-constant z-character z-escape">\\</span><span class="z-punctuation z-definition z-string">&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;＼&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;|&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;｜&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;?&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;？&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &#39;*&#39;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &#39;＊&#39;</span></span>
<span class="giallo-l"><span class="z-punctuation">}</span></span>
<span class="giallo-l"><span class="z-source">_WIN_RESERVED</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation"> {</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">    &#39;CON&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string">&#39;PRN&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string">&#39;AUX&#39;</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string">&#39;NUL&#39;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">    *</span><span class="z-punctuation">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-string">&#39;COM</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">i</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&#39;</span><span class="z-keyword z-control z-flow z-python"> for</span><span class="z-source"> i</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-support z-function z-builtin z-python"> range</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric">10</span><span class="z-punctuation">)),</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">    *</span><span class="z-punctuation">(</span><span class="z-storage z-type z-string z-python">f</span><span class="z-string">&#39;LPT</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">i</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&#39;</span><span class="z-keyword z-control z-flow z-python"> for</span><span class="z-source"> i</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-support z-function z-builtin z-python"> range</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-constant z-numeric">10</span><span class="z-punctuation">)),</span></span>
<span class="giallo-l"><span class="z-punctuation">}</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> _sanitize_for_windows</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">name</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">) -&gt;</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 禁止記号を全角へ</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    for</span><span class="z-source"> bad</span><span class="z-punctuation">,</span><span class="z-source"> rep</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-source"> _WIN_FORBIDDEN</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">items</span><span class="z-punctuation">():</span></span>
<span class="giallo-l"><span class="z-source">        name</span><span class="z-keyword z-operator"> =</span><span class="z-source"> name</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">replace</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">bad</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> rep</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 制御文字や末尾のピリオド/空白を除去</span></span>
<span class="giallo-l"><span class="z-source">    name</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation z-definition z-string"> &#39;&#39;</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">join</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ch</span><span class="z-keyword z-control z-flow z-python"> for</span><span class="z-meta z-function-call z-arguments z-python"> ch</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-meta z-function-call z-arguments z-python"> name</span><span class="z-keyword z-control z-flow z-python"> if</span><span class="z-constant z-numeric"> 32</span><span class="z-keyword z-operator"> &lt;=</span><span class="z-support z-function z-builtin z-python"> ord</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">ch</span><span class="z-punctuation">)</span><span class="z-keyword z-operator"> !=</span><span class="z-constant z-numeric"> 127</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    name</span><span class="z-keyword z-operator"> =</span><span class="z-source"> name</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">rstrip</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&#39; .&#39;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">    if not</span><span class="z-source"> name</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        name</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation z-definition z-string z-string"> &#39;無題&#39;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 予約名は末尾に全角アンダーを追加</span></span>
<span class="giallo-l"><span class="z-source">    base</span><span class="z-keyword z-operator"> =</span><span class="z-source"> name</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">split</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&#39;.&#39;</span><span class="z-punctuation">)[</span><span class="z-constant z-numeric">0</span><span class="z-punctuation">].</span><span class="z-meta z-function-call z-python">upper</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    if</span><span class="z-source"> base</span><span class="z-keyword z-operator z-logical z-python"> in</span><span class="z-source"> _WIN_RESERVED</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">        name</span><span class="z-keyword z-operator"> +=</span><span class="z-punctuation z-definition z-string z-string"> &#39;＿&#39;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 長すぎ防止（NTFSは255推奨）</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-meta z-indexed-name z-python"> name</span><span class="z-punctuation">[:</span><span class="z-constant z-numeric">200</span><span class="z-punctuation">]</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> make_dirnames</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">user_name</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> user_id</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> title</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> post_id</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">) -&gt;</span><span class="z-meta z-indexed-name z-python"> Tuple</span><span class="z-punctuation">[</span><span class="z-support z-type z-python">str</span><span class="z-punctuation">,</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">]:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    入力: ユーザー名, ユーザーID, タイトル, 投稿ID</span></span>
<span class="giallo-l"><span class="z-string">    返却: (&quot;ユーザー名(ユーザーID)&quot;, &quot;投稿タイトル(投稿ID)&quot;)</span></span>
<span class="giallo-l"><span class="z-string">    ※ Windowsで使えない文字は全角に置換</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    user_part</span><span class="z-keyword z-operator"> =</span><span class="z-storage z-type z-string z-python"> f</span><span class="z-string">&quot;</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">user_name</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">(</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">user_id</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">)&quot;</span></span>
<span class="giallo-l"><span class="z-source">    title_part</span><span class="z-keyword z-operator"> =</span><span class="z-storage z-type z-string z-python"> f</span><span class="z-string">&quot;</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">title</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">(</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">post_id</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">)&quot;</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-meta z-function-call z-python"> _sanitize_for_windows</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">user_part</span><span class="z-punctuation">),</span><span class="z-meta z-function-call z-python"> _sanitize_for_windows</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">title_part</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># ---------- 3) ディレクトリ作成 ----------</span></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> ensure_dirs</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">base_dir</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> os</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">PathLike</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> user_dir</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> post_dir</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">) -&gt;</span><span class="z-source"> pathlib</span><span class="z-punctuation">.</span><span class="z-source">Path</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    base_dir/user_dir/post_dir を作成（存在しなければ）</span></span>
<span class="giallo-l"><span class="z-string">    返却: 作成/既存の最終ディレクトリ Path</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    base</span><span class="z-keyword z-operator"> =</span><span class="z-source"> pathlib</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Path</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">base_dir</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    final</span><span class="z-keyword z-operator"> =</span><span class="z-source"> base</span><span class="z-keyword z-operator"> /</span><span class="z-source"> user_dir</span><span class="z-keyword z-operator"> /</span><span class="z-source"> post_dir</span></span>
<span class="giallo-l"><span class="z-source">    final</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">mkdir</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">parents</span><span class="z-keyword z-operator">=</span><span class="z-constant z-language z-python">True</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> exist_ok</span><span class="z-keyword z-operator">=</span><span class="z-constant z-language z-python">True</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> final</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># ---------- 4) 一括ダウンロード ----------</span></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> _ext_from_url</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">u</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">) -&gt;</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">    path</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> urlsplit</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">).</span><span class="z-source">path</span></span>
<span class="giallo-l"><span class="z-source">    ext</span><span class="z-keyword z-operator"> =</span><span class="z-source"> os</span><span class="z-punctuation">.</span><span class="z-source">path</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">splitext</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">path</span><span class="z-punctuation">)[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">]</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> ext</span><span class="z-keyword z-control z-flow z-python"> if</span><span class="z-source"> ext</span><span class="z-keyword z-control z-flow z-python"> else</span><span class="z-punctuation z-definition z-string z-string"> &quot;.jpg&quot;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> _download_with_retry</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">session</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> requests</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">Session</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> url</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> dst</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> pathlib</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">Path</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-variable z-parameter">                         max_retry</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> int</span><span class="z-keyword z-operator"> =</span><span class="z-constant z-numeric"> 3</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> backoff</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> float</span><span class="z-keyword z-operator"> =</span><span class="z-constant z-numeric"> 1.0</span><span class="z-punctuation">) -&gt;</span><span class="z-constant z-language z-python"> None</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    for</span><span class="z-source"> attempt</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-support z-function z-builtin z-python"> range</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> max_retry</span><span class="z-keyword z-operator"> +</span><span class="z-constant z-numeric"> 1</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        try</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">            with</span><span class="z-source"> session</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">get</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">url</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> stream</span><span class="z-keyword z-operator">=</span><span class="z-constant z-language z-python">True</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> timeout</span><span class="z-keyword z-operator">=</span><span class="z-constant z-numeric">30</span><span class="z-punctuation">)</span><span class="z-keyword z-control z-flow z-python"> as</span><span class="z-source"> r</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">                r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">raise_for_status</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">                with</span><span class="z-support z-function z-builtin z-python"> open</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">dst</span><span class="z-punctuation">,</span><span class="z-punctuation z-definition z-string z-string"> &quot;wb&quot;</span><span class="z-punctuation">)</span><span class="z-keyword z-control z-flow z-python"> as</span><span class="z-source"> f</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">                    for</span><span class="z-source"> chunk</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-source"> r</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">iter_content</span><span class="z-punctuation">(</span><span class="z-constant z-numeric">1</span><span class="z-keyword z-operator"> &lt;&lt;</span><span class="z-constant z-numeric"> 14</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">                        if</span><span class="z-source"> chunk</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">                            f</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">write</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">chunk</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">            return</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        except</span><span class="z-support z-type z-exception z-python"> Exception</span><span class="z-keyword z-control z-flow z-python"> as</span><span class="z-source"> e</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">            if</span><span class="z-source"> attempt</span><span class="z-keyword z-operator"> ==</span><span class="z-source"> max_retry</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">                raise</span></span>
<span class="giallo-l"><span class="z-source">            time</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">sleep</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">backoff</span><span class="z-keyword z-operator"> *</span><span class="z-meta z-function-call z-arguments z-python"> attempt</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage z-type z-function z-python">def</span><span class="z-entity z-name z-function"> download_post</span><span class="z-punctuation">(</span><span class="z-variable z-parameter">artwork_url</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> phpsessid</span><span class="z-punctuation">:</span><span class="z-support z-type z-python"> str</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> base_dir</span><span class="z-punctuation">:</span><span class="z-meta z-function z-parameters"> os</span><span class="z-punctuation">.</span><span class="z-meta z-function z-parameters">PathLike</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation z-definition z-string z-string"> &quot;.&quot;</span><span class="z-punctuation">) -&gt;</span><span class="z-source"> pathlib</span><span class="z-punctuation">.</span><span class="z-source">Path</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-string">    URLを受け取り、投稿のすべての画像を</span></span>
<span class="giallo-l"><span class="z-string">    「投稿id_000.ext」形式で base_dir/ユーザー名(ユーザid)/投稿タイトル(投稿id)/ に保存。</span></span>
<span class="giallo-l"><span class="z-string">    返却: 保存先ディレクトリ Path</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string">    &quot;&quot;&quot;</span></span>
<span class="giallo-l"><span class="z-source">    info</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> get_post_info</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">artwork_url</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> phpsessid</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">    user_dir</span><span class="z-punctuation">,</span><span class="z-source"> post_dir</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> make_dirnames</span><span class="z-punctuation">(</span><span class="z-meta z-indexed-name z-python">info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">user_name</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">],</span><span class="z-meta z-indexed-name z-python"> info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">user_id</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">],</span><span class="z-meta z-indexed-name z-python"> info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">title</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">],</span><span class="z-meta z-indexed-name z-python"> info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">post_id</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">])</span></span>
<span class="giallo-l"><span class="z-source">    out_dir</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> ensure_dirs</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">base_dir</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> user_dir</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> post_dir</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    s</span><span class="z-keyword z-operator"> =</span><span class="z-source"> requests</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">Session</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-source">    s</span><span class="z-punctuation">.</span><span class="z-source">headers</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">update</span><span class="z-punctuation">({</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;User-Agent&quot;</span><span class="z-punctuation">:</span><span class="z-meta z-function-call z-arguments z-python"> UA</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-string z-string">        &quot;Referer&quot;</span><span class="z-punctuation">:</span><span class="z-punctuation z-definition z-string z-string"> &quot;https://www.pixiv.net/&quot;</span><span class="z-punctuation">,</span></span>
<span class="giallo-l"><span class="z-punctuation">    })</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-source">    urls</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-indexed-name z-python"> info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">image_urls</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation">]</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 枚数に対してURLが不足している場合はURL長を優先（稀に非公開ページ等）</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    for</span><span class="z-source"> idx</span><span class="z-punctuation">,</span><span class="z-source"> u</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-support z-function z-builtin z-python"> enumerate</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">urls</span><span class="z-punctuation">):</span></span>
<span class="giallo-l"><span class="z-source">        ext</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> _ext_from_url</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">u</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-source">        fname</span><span class="z-keyword z-operator"> =</span><span class="z-storage z-type z-string z-python"> f</span><span class="z-string">&quot;</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-meta z-indexed-name z-python">info</span><span class="z-punctuation">[</span><span class="z-punctuation z-definition z-string">&#39;</span><span class="z-string">post_id</span><span class="z-punctuation z-definition z-string">&#39;</span><span class="z-punctuation">]</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">_</span><span class="z-constant z-character z-format z-placeholder z-other z-python">{</span><span class="z-source">idx</span><span class="z-storage z-type">:03d</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}{</span><span class="z-source">ext</span><span class="z-constant z-character z-format z-placeholder z-other z-python">}</span><span class="z-string">&quot;</span></span>
<span class="giallo-l"><span class="z-source">        dst</span><span class="z-keyword z-operator"> =</span><span class="z-source"> out_dir</span><span class="z-keyword z-operator"> /</span><span class="z-source"> fname</span></span>
<span class="giallo-l"><span class="z-meta z-function-call z-python">        _download_with_retry</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">s</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> u</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> dst</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    return</span><span class="z-source"> out_dir</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment"># ---------- サンプル実行 ----------</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">if</span><span class="z-support z-variable z-magic z-python"> __name__</span><span class="z-keyword z-operator"> ==</span><span class="z-punctuation z-definition z-string z-string"> &quot;__main__&quot;</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 使い方例：</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 1) 自分の PHPSESSID を入れる</span></span>
<span class="giallo-l"><span class="z-source">    PHPSESSID</span><span class="z-keyword z-operator"> =</span><span class="z-punctuation z-definition z-string z-string"> &quot;自分のPHPSESSID&quot;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # 2) 対象URL</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # URL = &quot;https://www.pixiv.net/artworks/133650546&quot;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">    # URL = sys.argv[1]</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">    for</span><span class="z-source"> URL</span><span class="z-keyword z-control z-flow z-python"> in</span><span class="z-source"> sys</span><span class="z-punctuation">.</span><span class="z-meta z-indexed-name z-python">argv</span><span class="z-punctuation">[</span><span class="z-constant z-numeric">1</span><span class="z-punctuation">:]:</span></span>
<span class="giallo-l"><span class="z-source">        URL</span><span class="z-keyword z-operator"> =</span><span class="z-source"> URL</span><span class="z-punctuation">.</span><span class="z-meta z-function-call z-python">strip</span><span class="z-punctuation">()</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python z-keyword z-operator z-logical z-python">        if not</span><span class="z-source"> URL</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">            continue</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-comment z-comment">        # 3) 実行</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        try</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-source">            saved_dir</span><span class="z-keyword z-operator"> =</span><span class="z-meta z-function-call z-python"> download_post</span><span class="z-punctuation">(</span><span class="z-meta z-function-call z-arguments z-python">URL</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> PHPSESSID</span><span class="z-punctuation">,</span><span class="z-variable z-parameter"> base_dir</span><span class="z-keyword z-operator">=</span><span class="z-punctuation z-definition z-string z-string">&quot;.&quot;</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-support z-function z-builtin z-python">            print</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;保存先:&quot;</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> saved_dir</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        except</span><span class="z-support z-type z-exception z-python"> NotImplementedError</span><span class="z-keyword z-control z-flow z-python"> as</span><span class="z-source"> e</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-support z-function z-builtin z-python">            print</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;非対応:&quot;</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> e</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"><span class="z-keyword z-control z-flow z-python">        except</span><span class="z-support z-type z-exception z-python"> Exception</span><span class="z-keyword z-control z-flow z-python"> as</span><span class="z-source"> e</span><span class="z-punctuation">:</span></span>
<span class="giallo-l"><span class="z-support z-function z-builtin z-python">            print</span><span class="z-punctuation">(</span><span class="z-punctuation z-definition z-string z-string">&quot;エラー:&quot;</span><span class="z-punctuation">,</span><span class="z-meta z-function-call z-arguments z-python"> e</span><span class="z-punctuation">)</span></span>
<span class="giallo-l"></span></code></pre>
<p>使い方は</p>
<pre class="giallo z-code"><code data-lang="shellscript"><span class="giallo-l"><span class="z-entity z-name z-function">python</span><span class="z-string"> pxdl.py https://www.pixiv.net/artworks/133393158 https://www.pixiv.net/artworks/133226483 https://www.pixiv.net/artworks/131910195</span></span></code></pre>
<p>みたいに、コマンドライン引数でurlを与えるだけだ。そうすると</p>
<p>ユーザ名(ユーザID)/投稿タイトル(投稿id)</p>
<p>のフォルダに一括ダウンロードする。</p>
<h1 id="phpsessidnodiao-befang">PHPSESSIDの調べ方</h1>
<p>R-18など、ログインしてないと見れない画像を取得するためにPHPSESSIDというものが必要だそうだ。これはPixivにログインしている状態でブラウザのクッキー情報から確認できる。</p>
<p>Firefoxなら</p>
<ol>
<li>Pixiv にログインして作品ページを開く。</li>
<li>F12 キーで 開発ツール を開く。</li>
<li>上部タブの「ストレージ」をクリック。</li>
<li>左メニューから Cookies → https://www.pixiv.net を選択。</li>
<li>一覧の中から PHPSESSID を探し、その値をコピー。</li>
</ol>

        </section>
        
        

        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
            
            
            

            
        
        </article>
</main>


<span id="copy-success" class="hidden">
        Copied!
    </span>
    <span id="copy-init" class="hidden">
        Copy code to clipboard
    </span>
    <script defer src="https://662611034.github.io/js/copyCodeToClipboard.min.js"></script>


    </div>
    <footer>
    <section>
        <nav class="socials nav-navs"><ul><li>
                        <a class="nav-links no-hover-padding social" rel="" 

 href="https://662611034.github.io/atom.xml">
                        <img loading="lazy" alt="feed" title="feed" src="https://662611034.github.io/social_icons/rss.svg">
                        </a>
                    </li>
                </ul>
            
        </nav>

        
        <nav class="nav-navs">
        </nav>

        <div class="credits">
            <small>
                

                
                Powered by
                <a rel="" 

 href="https://www.getzola.org">Zola</a>
                &amp;
                <a rel="" 

 href="https://github.com/welpo/tabi">tabi</a>

                </small>
        </div>
    </section>

    <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
    <h1 id="modalTitle" class="visually-hidden">Search</h1>
    <div id="modal-content">
        <div id="searchBar">
            <div class="search-icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                    <path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/>
                </svg>
            </div>
            <input id="searchInput" role="combobox" autocomplete="off" spellcheck="false" aria-expanded="false" aria-controls="results-container" placeholder="Search…"/>
            <div id="clear-search" class="close-icon interactive-icon" tabindex="0" role="button" title="Clear search">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                </svg>
            </div>
        </div>
        <div id="results-container">
            <div id="results-info"><span id="zero_results"> No results</span>
                <span id="one_results"> $NUMBER result</span>
                <span id="many_results"> $NUMBER results</span><span id="two_results"> $NUMBER results</span>
                <span id="few_results"> $NUMBER results</span>
            </div>
            <div id="results" role="listbox"></div>
        </div>
    </div>
</div>
</footer>


    
    
</body>

</html>
